<div class="page">
  <header class="press-header">
    <div class="press-header__mast">
      <span class="press-header__edition">Oz Crickets Gazette</span>
      <h1>Today's Bargain Dispatch</h1>
      <p>
        A retro-styled digest of live OzBargain finds, refreshed all day and sorted for savvy shoppers.
      </p>
    </div>
    <div class="press-header__actions">
      <label class="search" for="deal-search">
        <span class="search__label">Search the archive</span>
        <input
          id="deal-search"
          type="search"
          placeholder="Search by store, keyword, or category"
          [value]="searchTerm()"
          (input)="handleSearchInput($event)"
        />
      </label>
      <div class="press-header__buttons">
        <button
          type="button"
          class="button ghost"
          (click)="clearFilters()"
          [disabled]="!selectedCategory() && !selectedStore() && !searchTerm()"
        >
          Clear filters
        </button>
        <button type="button" class="button primary" (click)="refresh()" [disabled]="loading()">
          <ng-container *ngIf="!loading(); else refreshing">Refresh feed</ng-container>
        </button>
        <ng-template #refreshing>Loading…</ng-template>
      </div>
      <div class="press-header__meta">
        <span *ngIf="lastUpdated() as updated">Updated {{ updated | date: 'shortTime' }}</span>
        <span class="divider" aria-hidden="true">•</span>
        <span>{{ deals().length }} live deals</span>
      </div>
    </div>
  </header>

  <section class="ticker" *ngIf="filteredDeals().length">
    <div class="ticker__label">Breaking bargains</div>
    <div class="ticker__track" aria-live="polite">
      <span class="ticker__item" *ngFor="let deal of filteredDeals() | slice:0:15">
        {{ deal.title }}
      </span>
    </div>
  </section>

  <main class="press-layout">
    <section class="press-feed" *ngIf="!error(); else errorState">
      <div class="filter-ribbon" *ngIf="categories().length || stores().length">
        <section class="filter-panel" *ngIf="categories().length">
          <h2>Categories</h2>
          <div class="chip-row">
            <button
              type="button"
              class="chip"
              [class.active]="!selectedCategory()"
              (click)="selectCategory(null)"
            >
              All
            </button>
            <button
              type="button"
              class="chip"
              *ngFor="let category of categories() | slice:0:10"
              [class.active]="selectedCategory() === category.name"
              (click)="selectCategory(category.name)"
            >
              {{ category.name }}
              <span class="chip__count">{{ category.count }}</span>
            </button>
          </div>
        </section>
        <section class="filter-panel" *ngIf="stores().length">
          <h2>Stores</h2>
          <div class="chip-row">
            <button
              type="button"
              class="chip"
              [class.active]="!selectedStore()"
              (click)="selectStore(null)"
            >
              Any store
            </button>
            <button
              type="button"
              class="chip"
              *ngFor="let store of stores() | slice:0:8"
              [class.active]="selectedStore() === store.name"
              (click)="selectStore(store.name)"
            >
              {{ store.name }}
              <span class="chip__count">{{ store.count }}</span>
            </button>
          </div>
        </section>
      </div>

      <ng-container *ngIf="loading(); else loaded">
        <div class="ledger-skeleton">
          <div class="ledger-skeleton__row" *ngFor="let idx of skeletonPlaceholders" [style.animation-delay.ms]="idx * 80">
            <span></span><span></span><span></span>
          </div>
        </div>
      </ng-container>

      <ng-template #loaded>
        <ng-container *ngIf="filteredDeals() as deals">
          <article class="lead-story" *ngIf="heroDeal() as hero">
            <div class="lead-story__flag">
              <span>Lead deal</span>
              <time>{{ getRelativeTime(hero.postedAt) }}</time>
            </div>
            <div class="lead-story__content">
              <div class="lead-story__text">
                <h2>{{ hero.title }}</h2>
                <p *ngIf="hero.summary">{{ hero.summary }}</p>
                <div class="lead-story__meta">
                  <span *ngIf="hero.store">{{ hero.store }}</span>
                  <span *ngIf="hero.priceLabel">{{ hero.priceLabel }}</span>
                  <span *ngFor="let category of hero.categories">{{ category }}</span>
                </div>
                <div
                  class="lead-story__insight"
                  *ngIf="hero.score > 0 || hero.commentCount > 0 || hero.clickCount > 0"
                >
                  <div class="lead-story__stats">
                    <div class="lead-story__stat" *ngIf="hero.score > 0">
                      <strong>{{ hero.score }}</strong>
                      <span>Score</span>
                    </div>
                    <div class="lead-story__stat" *ngIf="hero.commentCount > 0">
                      <strong>{{ hero.commentCount | number }}</strong>
                      <span>Comments</span>
                    </div>
                    <div class="lead-story__stat" *ngIf="hero.clickCount > 0">
                      <strong>{{ hero.clickCount | number }}</strong>
                      <span>Clicks</span>
                    </div>
                  </div>
                </div>
                <div class="lead-story__actions">
                  <a class="lead-story__cta" [href]="hero.link" target="_blank" rel="noopener">View on OzBargain</a>
                  <a
                    *ngIf="hero.externalUrl"
                    class="lead-story__cta secondary"
                    [href]="hero.externalUrl"
                    target="_blank"
                    rel="noopener"
                  >
                    Go to store
                  </a>
                </div>
              </div>
              <div class="lead-story__media" *ngIf="hero.thumbnail">
                <img [src]="hero.thumbnail" [alt]="hero.title" loading="lazy" />
              </div>
            </div>
          </article>

          <section class="deal-ledger" *ngIf="deals.length; else emptyState">
            <header class="deal-ledger__header">
              <span>Store</span>
              <span>Deal summary</span>
              <span>Reporter</span>
              <span>Opened</span>
            </header>
            <ng-container *ngFor="let deal of deals">
              <article class="deal-entry" *ngIf="heroDealId() !== deal.id">
                <div class="deal-entry__store">
                  <strong>{{ deal.store ?? 'Community' }}</strong>
                  <span class="deal-entry__time">{{ getRelativeTime(deal.postedAt) }}</span>
                </div>
                <div class="deal-entry__summary">
                  <h3>{{ deal.title }}</h3>
                  <p *ngIf="deal.summary">{{ deal.summary }}</p>
                  <div class="deal-entry__tags">
                    <span class="tag" *ngIf="deal.priceLabel">{{ deal.priceLabel }}</span>
                    <span class="tag muted" *ngFor="let category of deal.categories">{{ category }}</span>
                  </div>
                  <div
                    class="deal-entry__metrics"
                    *ngIf="deal.score > 0 || deal.commentCount > 0 || deal.clickCount > 0"
                  >
                    <span *ngIf="deal.score > 0"><strong>{{ deal.score }}</strong> score</span>
                    <span *ngIf="deal.commentCount > 0"
                      ><strong>{{ deal.commentCount | number }}</strong> comments</span
                    >
                    <span *ngIf="deal.clickCount > 0"
                      ><strong>{{ deal.clickCount | number }}</strong> clicks</span
                    >
                  </div>
                </div>
                <div class="deal-entry__author">{{ deal.author }}</div>
                <div class="deal-entry__link">
                  <a class="deal-entry__primary" [href]="deal.link" target="_blank" rel="noopener"
                    >Inspect deal</a
                  >
                  <a
                    *ngIf="deal.externalUrl"
                    class="deal-entry__secondary"
                    [href]="deal.externalUrl"
                    target="_blank"
                    rel="noopener"
                  >
                    Visit store
                  </a>
                </div>
              </article>
            </ng-container>
          </section>
        </ng-container>
      </ng-template>
    </section>

    <aside class="sidebar">
      <section class="sidebar-card">
        <h2>Newsroom stats</h2>
        <ul>
          <li>
            <span>Total deals</span>
            <strong>{{ deals().length }}</strong>
          </li>
          <li>
            <span>Community votes logged</span>
            <strong>{{ totalCommunityVotes() | number }}</strong>
          </li>
          <li>
            <span>Clickthrough pulses</span>
            <strong>{{ totalClickthroughs() | number }}</strong>
          </li>
          <li>
            <span>Most active category</span>
            <strong>{{ topCategoryName() ?? '—' }}</strong>
          </li>
          <li>
            <span>Most active store</span>
            <strong>{{ topStoreName() ?? '—' }}</strong>
          </li>
          <li>
            <span>Latest refresh</span>
            <strong *ngIf="lastUpdated() as updated">{{ updated | date: 'mediumTime' }}</strong>
            <strong *ngIf="!lastUpdated()">—</strong>
          </li>
        </ul>
      </section>

      <section class="sidebar-card" *ngIf="stores().length">
        <h2>Store roll call</h2>
        <ol>
          <li *ngFor="let store of stores() | slice:0:6">
            <span>{{ store.name }}</span>
            <span class="badge">{{ store.count }}</span>
          </li>
        </ol>
      </section>

      <section
        class="sidebar-card engagement-report"
        *ngIf="topScoringDeal() || topDiscussedDeal() || topClickedDeal()"
      >
        <h2>Engagement desk</h2>
        <ul>
          <li *ngIf="topScoringDeal() as scoring">
            <div class="engagement-report__metric">
              <strong>{{ scoring.score }}</strong>
              <span>Top score</span>
            </div>
            <p>{{ scoring.title }}</p>
          </li>
          <li *ngIf="topDiscussedDeal() as discussed">
            <div class="engagement-report__metric">
              <strong>{{ discussed.commentCount | number }}</strong>
              <span>Most discussed</span>
            </div>
            <p>{{ discussed.title }}</p>
          </li>
          <li *ngIf="topClickedDeal() as clicked">
            <div class="engagement-report__metric">
              <strong>{{ clicked.clickCount | number }}</strong>
              <span>Most clicks</span>
            </div>
            <p>{{ clicked.title }}</p>
          </li>
        </ul>
      </section>

      <section class="sidebar-card" *ngIf="categories().length">
        <h2>Category barometer</h2>
        <ul class="progress-list">
          <li *ngFor="let category of categories() | slice:0:6">
            <div class="progress-list__label">
              <span>{{ category.name }}</span>
              <span>{{ category.count }}</span>
            </div>
            <div class="progress">
              <div
                class="progress__bar"
                [style.width.%]="topCategoryCount() ? (category.count / topCategoryCount()) * 100 : 0"
              ></div>
            </div>
          </li>
        </ul>
      </section>
    </aside>
  </main>
</div>

<ng-template #errorState>
  <section class="error">
    <h2>Feed unavailable</h2>
    <p>{{ error() }}</p>
    <button type="button" class="button primary" (click)="refresh()">Try again</button>
  </section>
</ng-template>

<ng-template #emptyState>
  <div class="empty">
    <h3>No deals match these filters</h3>
    <p>Adjust your filters to reveal more of today's bargains.</p>
  </div>
</ng-template>
